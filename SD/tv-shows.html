<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shows</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    :root{--bg:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--panel:#0f172a;--border:#1e2a3f;--shadow:0 10px 30px rgba(0,0,0,.3);--radius:12px}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    header{padding:20px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:linear-gradient(180deg,#0b1220,#0b1220f2);backdrop-filter:saturate(140%) blur(6px);z-index:10}
    a.back{color:#e5e7eb;text-decoration:none;background:#111827;border:1px solid var(--border);padding:.45rem .7rem;border-radius:8px}
    .toolbar{display:flex;gap:.6rem;flex-wrap:wrap;padding:10px 16px;background:#0c1428;border-top:1px solid var(--border);border-bottom:1px solid var(--border);position:sticky;top:64px;z-index:9}
    .toolbar input{background:#0f1a32;border:1px solid #223049;color:#e5e7eb;border-radius:8px;padding:.5rem .6rem;flex:1 1 260px}
    main{flex:1;max-width:1200px;margin:0 auto;width:100%;padding:16px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
    .card{background:linear-gradient(180deg,#121a30,#0f172a);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;box-shadow:var(--shadow);transition:transform .2s ease}
    .card:hover{transform:translateY(-3px)}
    .thumb{width:100%;aspect-ratio:2/3;object-fit:cover;display:block}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .epi{background:#0f1a32;border:1px solid #23324c;border-radius:10px;padding:10px;cursor:pointer}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .content{background:#0f172a;border:1px solid var(--border);border-radius:12px;padding:16px;width:min(96vw,1100px)}
    video{width:100%;height:auto;max-height:80dvh;border-radius:10px;background:#000;object-fit:contain}
    @media (orientation: landscape){
      video{max-height:90dvh}
    }
    .row{display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin-top:8px}
    .row .left{display:flex;gap:.5rem;align-items:center}
    button{background:#1a2a44;color:#e5e7eb;border:1px solid #2a3a58;padding:.45rem .7rem;border-radius:8px;cursor:pointer}
    select{background:#0f1a32;border:1px solid #223049;color:#e5e7eb;border-radius:8px;padding:.45rem .7rem}
  </style>
</head>
<body>
  <header>
    <h1>Shows</h1>
    <a class="back" href="tv.html">← Hub</a>
  </header>

  <div class="toolbar">
    <input id="q" type="search" placeholder="Search shows…" aria-label="Search shows">
  </div>

  <main>
    <div id="grid" class="grid"></div>
  </main>

  <div id="vm" class="modal">
    <div class="content">
    <video id="player" controls preload="metadata" playsinline webkit-playsinline x5-playsinline></video>
      <div class="row">
        <div class="left">
          <label for="subSel">Subtitles:</label>
          <select id="subSel"><option value="off">Off</option></select>
        </div>
        <div>
      <button id="fsBtn" title="Fullscreen">⛶ Fullscreen</button>
          <button id="nextBtn">Next ▶</button>
          <button onclick="closeVideo()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const videoExts=['.mp4','.mkv','.avi','.mov','.webm'];
    const grid=document.getElementById('grid');
    const q=document.getElementById('q');
    const modal=document.getElementById('vm');
    const player=document.getElementById('player');
    const subSel=document.getElementById('subSel');
    const nextBtn=document.getElementById('nextBtn');
    let shows=[], view=[], currentList=[], currentIdx=0;

  function isVid(n){return videoExts.some(e=>n.toLowerCase().endsWith(e))}
  function mediaUrl(p){return encodeURI('/' + p)}

    function showPosterPath(showName){
      // Poster sits in Shows/ as "<ShowName>.jpg"
      return `Shows/${showName}.jpg`;
    }
    function srtCandidates(filePath){
      const base=filePath.replace(/\.[^/.]+$/, '');
      return [`${base}.srt`, `${base}.SRT`];
    }

    async function list(path){
      const res=await fetch(path); const html=await res.text();
      const doc=new DOMParser().parseFromString(html,'text/html');
      const links=[...doc.querySelectorAll('a')].map(a=>a.getAttribute('href')).filter(Boolean);
      return links
        .filter(h=>!h.startsWith('?') && !h.startsWith('/'))
        .map(h=>decodeURIComponent(h))
        .filter(h=>!['..','../','.','./'].includes(h));
    }

    async function scanShows(){
      const base='Shows/';
      const folders=(await list(base)).filter(h=>h.endsWith('/')).map(h=>h.replace(/\/$/,''));
      shows=[];
      for(const dir of folders){
        const entries=await list(`${base}${dir}/`);
        const episodes=entries.filter(isVid).map(f=>({ name:f.replace(/\.[^/.]+$/, ''), file:`${base}${dir}/${f}` }));
        const cover=showPosterPath(dir);
        shows.push({ name:dir, cover, episodes });
      }
      shows.sort((a,b)=>a.name.localeCompare(b.name));
      apply('');
    }

    function apply(term){
      const t=term.trim().toLowerCase();
      view=shows.filter(s=>!t || s.name.toLowerCase().includes(t));
      render();
    }
    function render(){
      const frag=document.createDocumentFragment();
      view.forEach(s=>{
        const d=document.createElement('div'); d.className='card';
        d.innerHTML = `<img class="thumb" loading="lazy" alt="${s.name}" src="${s.cover}" onerror="this.style.display='none'">`;
        d.onclick=()=>openEpisodes(s);
        frag.appendChild(d);
      });
      grid.innerHTML=''; grid.appendChild(frag);
    }

    function openEpisodes(show){
      // replace grid with episode list for this show
      currentList = show.episodes;
      const wrap=document.createElement('div');
      wrap.className='list';
      const back=document.createElement('button'); back.textContent='← Back to shows'; back.onclick=()=>render();
      wrap.appendChild(back);
      show.episodes.forEach((ep,i)=>{
        const b=document.createElement('div'); b.className='epi';
        b.textContent=ep.name || `Episode ${i+1}`; b.onclick=()=>play(i);
        wrap.appendChild(b);
      });
      grid.innerHTML=''; grid.appendChild(wrap);
    }

    function resetTracks(){ while(player.firstChild) player.removeChild(player.firstChild); }
    function addTrack(label,src){ const t=document.createElement('track'); t.kind='subtitles'; t.label=label; t.srclang='en'; t.src=src; player.appendChild(t); return t; }

    function srtToVtt(srt){
      const blocks = srt.replace(/\r/g,'').split('\n\n');
      const out = blocks.map(b=>{
        const lines = b.split('\n');
        if(lines[0] && /^\d+$/.test(lines[0])) lines.shift();
        for(let i=0;i<lines.length;i++){
          if(lines[i].includes('-->')){
            lines[i] = lines[i].replace(/,(\d{3})/g, '.$1');
            break;
          }
        }
        return lines.join('\n');
      }).join('\n\n');
      return 'WEBVTT\n\n' + out;
    }

    async function loadSubs(file){
      subSel.innerHTML='<option value="off">Off</option>';
      for(const cand of srtCandidates(file)){
        try{ const r=await fetch('/' + cand,{method:'GET'}); if(r.ok){ const text=await r.text(); const vtt=srtToVtt(text); const blob=new Blob([vtt],{type:'text/vtt'}); const url=URL.createObjectURL(blob); const opt=document.createElement('option'); opt.value=url; opt.textContent='English'; subSel.appendChild(opt); subSel.value=url; subSel.dispatchEvent(new Event('change')); break; } }catch(_){ }
      }
    }

    async function play(i){
      if(i<0||i>=currentList.length) return; currentIdx=i;
      const ep=currentList[i];
      player.pause(); player.removeAttribute('src'); resetTracks(); player.load();
      await loadSubs(ep.file);
      player.src=mediaUrl(ep.file);
      modal.style.display='flex';
      player.play().catch(()=>{});
    }
    function enterFS(){
      const el = player;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
      else if (el.webkitEnterFullscreen) el.webkitEnterFullscreen(); // iOS video
    }
    function exitFS(){
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
    }
    function toggleFS(){
      const fsEl = document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
      if (fsEl) exitFS(); else enterFS();
    }
    function closeVideo(){ player.pause(); player.removeAttribute('src'); resetTracks(); player.load(); modal.style.display='none'; }
    nextBtn.onclick=()=>{ if(currentIdx+1<currentList.length) play(currentIdx+1); }
    player.addEventListener('ended',()=>{ if(currentIdx+1<currentList.length) play(currentIdx+1); });
    subSel.addEventListener('change',()=>{
      const v=subSel.value; for(const tr of player.textTracks) tr.mode='disabled';
      if(v==='off') return; let el=[...player.querySelectorAll('track')].find(t=>t.src===v);
      if(!el) el=addTrack('English', v); el.mode='showing';
      for(const t of player.textTracks){ if(t.label==='English') t.mode='showing'; }
    });

    q.addEventListener('input',e=>apply(e.target.value));
    window.addEventListener('keydown',e=>{ if(e.key==='Escape') closeVideo(); });
    modal.addEventListener('click',e=>{ if(e.target===modal) closeVideo(); });

  // Fullscreen button
  document.getElementById('fsBtn').addEventListener('click', toggleFS);

  // Handle rotation/resizes – adjust CSS var for mobile 100vh quirks
  function setVh(){ document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
  window.addEventListener('resize', setVh); window.addEventListener('orientationchange', setVh); setVh();

    scanShows();
  </script>
</body>
</html>
